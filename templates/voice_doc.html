<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sprachdokumentation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0"></script>
</head>
<body>

<div class="header header-mobile">
  <div class="header-title">
    <span class="icon">ğŸ™ï¸</span>
    <span>Sprachdokumentation</span>
  </div>
  <div class="nav-links">
      {% if current_nurse %}
            <span class="current-nurse-label">
                ğŸ‘©â€âš•ï¸ Eingeloggt als: {{ current_nurse["name"] }}
            </span>
        {% endif %}
    <a class="nav-pill" href="{{ url_for('home') }}">ğŸ¥ Home</a>
  </div>
</div>

<div class="container container-mobile">

  <div class="section-card mobile-card">

  <h3>Patient-ID scannen</h3>

  <div class="scan-row">
    <button type="button" class="btn-primary" id="startScanBtn">ğŸ“· Scan starten</button>
    <button type="button" class="btn-secondary" id="stopScanBtn" style="display:none;">â¹ Stop</button>
  </div>

    <br>

  <div id="scanStatus" class="scan-status">Bereit.</div>

  <div class="scan-preview" id="scanPreview" style="display:none;">
    <video id="scanVideo" playsinline></video>
  </div>



   <form method="POST" action="{{ url_for('voice_doc') }}" class="mobile-form">
      <label class="mobile-label" for="patientIdentifierInput"></label>
      <input
        type="text"
        id="patientIdentifierInput"
        name="patient_identifier"
        class="mobile-input"
        inputmode="text"
        placeholder="Oder Patient-ID hier eingeben: z.B. P-100001"
        autocomplete="off">


      <div class="mobile-row">
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient teilgewaschen')">TeilwÃ¤sche</button>
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient ganzgewaschen')">GanzwÃ¤sche</button>
      </div>

      <div class="chip-grid">
        <button type="button" class="chip" onclick="fillPhrase('Inhalation durchgefÃ¼hrt')">Inhalation</button>
        <button type="button" class="chip" onclick="fillPhrase('Urinflasche geleert')">Urinflasche</button>
        <button type="button" class="chip" onclick="fillPhrase('patient links gelagert')">Lagerung links</button>
        <button type="button" class="chip" onclick="fillPhrase('patient rechts gelagert')">Lagerung rechts</button>
        <button type="button" class="chip" onclick="fillPhrase('patient zÃ¤hne geputzt')">ZÃ¤hne geputzt</button>
        <button type="button" class="chip" onclick="fillPhrase('patient geholfen beim Essen')">Essen geholfen</button>
        <button type="button" class="chip" onclick="fillPhrase('Patient aufgeklÃ¤rt')">Info erklÃ¤rt</button>
        <button type="button" class="chip" onclick="fillPhrase('Postop Kontrolle')">Post-OP Check</button>
        <button type="button" class="chip" onclick="fillPhrase('Mobilisation')">Mobilisation</button>
        <button type="button" class="chip" onclick="fillPhrase('OberkÃ¶rperhochlagerung')">OberkÃ¶rperhochlagerung</button>
        <button type="button" class="chip" onclick="fillPhrase('Orientierungshilfen')">Orientierungshilfe</button>
        <button type="button" class="chip" onclick="fillPhrase('Wundbehandlung')">Wundbehandlung</button>

      </div>

      <label class="mobile-label" for="selected_text">Dokumentation nach Auswahl</label>
      <textarea
        id="selected_text"
        name="selected_text"
        class="mobile-textarea"
        rows="4"
        placeholder="WÃ¤hlen Sie was aus: z.B. Lagerung links"
      ></textarea>

        <label class="mobile-label" for="spoken_text">Beobachtung</label>
        <textarea
          id="spoken_text"
          name="spoken_text"
          class="mobile-textarea"
          rows="3"
          placeholder="Sprich oder tippe: z.B. 'Patient klagt Ã¼ber Ãœbelkeit, Haut blass', â€¦"
        ></textarea>

        <div class="mobile-row">
        <button type="button" class="btn-primary btn-full" id="btnStart">ğŸ™ï¸ Start</button>
        <button type="button" class="btn-secondary btn-full" id="btnStop" disabled>â¹ï¸ Stop</button>
      </div>

      <button type="submit" class="btn-primary btn-full">Dokumentieren</button>

      <p class="mobile-hint">
        Hinweis: iPhone Safari benÃ¶tigt <strong>HTTPS</strong> und eine Nutzeraktion (Button) fÃ¼r Mikrofonzugriff.
      </p>
    </form>
  </div>
  </div>


<script>
function fillPhrase(text) {
  const box = document.getElementById("selected_text");
  if (!box.value.trim()) box.value = text;
  else box.value = box.value.trim() + "\n" + text;
  box.focus();
}

/* --- Web Speech API (works on many browsers, iOS Safari support varies) --- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;

const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const spokenBox = document.getElementById("spoken_text");

if (SpeechRecognition) {
  rec = new SpeechRecognition();
  rec.lang = "de-DE";
  rec.interimResults = true;
  rec.continuous = true;

  let finalText = "";

  rec.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const t = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalText += t + "\n";
      else interim += t;
    }
    spokenBox.value = (finalText + interim).trim();
  };

  rec.onend = () => {
    btnStart.disabled = false;
    btnStop.disabled = true;
  };

  btnStart.addEventListener("click", () => {
    try {
      btnStart.disabled = true;
      btnStop.disabled = false;
      rec.start();
    } catch (e) {
      // start can throw if called twice quickly
      btnStart.disabled = false;
      btnStop.disabled = true;
      console.log(e);
    }
  });

  btnStop.addEventListener("click", () => {
    btnStop.disabled = true;
    btnStart.disabled = false;
    rec.stop();
  });
} else {
  // Hide voice buttons if unsupported
  btnStart.style.display = "none";
  btnStop.style.display  = "none";
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let scanStream = null;
  let scanning = false;

  let zxingReader = null;
  let zxingControls = null;

  const startBtn   = document.getElementById("startScanBtn");
  const stopBtn    = document.getElementById("stopScanBtn");
  const statusEl   = document.getElementById("scanStatus");
  const previewEl  = document.getElementById("scanPreview");
  const videoEl    = document.getElementById("scanVideo");
  const inputEl    = document.getElementById("patientIdentifierInput");

  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  async function stopScan() {
    scanning = false;

    // Stop native camera stream (BarcodeDetector path)
    if (scanStream) {
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;
    }

    // Stop ZXing (fallback path)
    if (zxingControls) {
      zxingControls.stop();
      zxingControls = null;
    }
    if (zxingReader) {
      try { zxingReader.reset(); } catch(e) {}
      zxingReader = null;
    }

    // Reset UI
    if (videoEl) {
      try { videoEl.pause(); } catch(e) {}
      videoEl.srcObject = null;
    }
    if (previewEl) previewEl.style.display = "none";
    if (startBtn) startBtn.style.display = "inline-block";
    if (stopBtn) stopBtn.style.display = "none";
    setStatus("Scan gestoppt.");
  }

  async function startScan() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus("Kamera nicht verfÃ¼gbar. Bitte Patient-ID manuell eingeben.");
      return;
    }

    // ---------- Option A: BarcodeDetector (if supported) ----------
    if ("BarcodeDetector" in window) {
      let detector;
      try {
        detector = new BarcodeDetector({
          formats: ["qr_code","code_128","code_39","ean_13","ean_8","upc_a","upc_e"]
        });
      } catch (e) {
        // Some browsers expose BarcodeDetector but throw on formats
        detector = new BarcodeDetector();
      }

      try {
        scanStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });

        videoEl.srcObject = scanStream;
        await videoEl.play();

        scanning = true;
        previewEl.style.display = "block";
        startBtn.style.display = "none";
        stopBtn.style.display = "inline-block";
        setStatus("Scanneâ€¦ halte den Code ruhig in die Kamera.");

        const tick = async () => {
          if (!scanning) return;

          try {
            const codes = await detector.detect(videoEl);
            if (codes && codes.length) {
              const raw = (codes[0].rawValue || "").trim();
              if (raw) {
                inputEl.value = raw;
                setStatus("Patienten-ID erkannt: " + raw);
                await stopScan();
                return;
              }
            }
          } catch (e) {
            // ignore transient detection errors
          }

          requestAnimationFrame(tick);
        };

        requestAnimationFrame(tick);
        return;

      } catch (err) {
        setStatus("Kamera-Zugriff Fehler: " + (err?.message || err));
        await stopScan();
        return;
      }
    }

    // ---------- Option B: ZXing fallback (works on iOS Safari) ----------
    if (!window.ZXing || !ZXing.BrowserMultiFormatReader) {
      setStatus("Scanner-Library (ZXing) nicht geladen. Bitte Seite neu laden.");
      return;
    }

    try {
      zxingReader = new ZXing.BrowserMultiFormatReader();

      previewEl.style.display = "block";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      setStatus("Scanneâ€¦ halte den Code ruhig in die Kamera.");

      zxingControls = await zxingReader.decodeFromVideoDevice(
        null, // auto camera selection; iOS usually picks back cam
        videoEl,
        async (result, err) => {
          if (result) {
            const value = result.getText().trim();
            if (value) {
              inputEl.value = value;
              setStatus("Patienten-ID erkannt: " + value);
              await stopScan();
            }
          }
        }
      );

    } catch (e) {
      setStatus("Scanner-Fehler: " + (e?.message || e));
      await stopScan();
    }
  }

  startBtn?.addEventListener("click", startScan);
  stopBtn?.addEventListener("click", stopScan);
});
</script>



</body>
</html>
