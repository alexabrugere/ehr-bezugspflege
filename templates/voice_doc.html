<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sprachdokumentation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      initScanner();
    });
  </script>
</head>
<body>

<div class="header">
  <div class="header-title">
    <span class="icon">üè•</span>
    <span>EHR Kardio ‚Äì Station</span>
  </div>

  <div class="nav-links">
    {% if current_nurse %}
      <span class="current-nurse-label">üë©‚Äç‚öïÔ∏è {{ current_nurse["name"] }}</span>
    {% endif %}
    <a href="{{ url_for('home') }}">Home</a>
    <a href="{{ url_for('tasks_view') }}">Aufgaben f√ºr Alle</a>
    <a href="{{ url_for('voice_doc') }}">Sprachdoku</a>
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<div class="container container-mobile">

  <div class="section-card mobile-card">

  <h2>Sprachdokumentation</h2>

  <h3>Patient-ID scannen</h3>

  <div class="scan-row">
    <button type="button" class="btn-primary" id="startScanBtn">üì∑ Scan starten</button>
    <button type="button" class="btn-secondary" id="stopScanBtn" style="display:none;">‚èπ Stop</button>
  </div>

    <br>

  <div id="scanStatus" class="scan-status">Bereit.</div>

  <div class="scan-preview" id="scanPreview" style="display:none;">
    <video id="scanVideo" playsinline></video>
  </div>



   <form method="POST" action="{{ url_for('voice_doc') }}" class="mobile-form">
      <label class="mobile-label" for="patientIdentifierInput"></label>
      <input
        type="text"
        id="patientIdentifierInput"
        name="patient_identifier"
        class="mobile-input"
        inputmode="text"
        placeholder="Oder hier eingeben: z.B. P-100001"
        autocomplete="off">


      <div class="mobile-row">
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient teilgewaschen')">Teilw√§sche</button>
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient ganzgewaschen')">Ganzw√§sche</button>
      </div>

      <div class="chip-grid">
        <button type="button" class="chip" onclick="fillPhrase('inhaliert')">Inhalation</button>
        <button type="button" class="chip" onclick="fillPhrase('urin geleert')">Urinflasche</button>
        <button type="button" class="chip" onclick="fillPhrase('gelagert')">Lagerung links</button>
        <button type="button" class="chip" onclick="fillPhrase('gelagert')">Lagerung rechts</button>
        <button type="button" class="chip" onclick="fillPhrase('z√§hne geputzt')">Z√§hne geputzt</button>
        <button type="button" class="chip" onclick="fillPhrase('essen')">Essen geholfen</button>
        <button type="button" class="chip" onclick="fillPhrase('Patient aufgekl√§rt')">Info erkl√§rt</button>
        <button type="button" class="chip" onclick="fillPhrase('op gepr√ºft')">Post-OP Check</button>
        <button type="button" class="chip" onclick="fillPhrase('mobilisiert')">Mobilisation</button>
        <button type="button" class="chip" onclick="fillPhrase('hochlagert')">Hochlagerung</button>
        <button type="button" class="chip" onclick="fillPhrase('orientiert')">Orientierungshilfe</button>
        <button type="button" class="chip" onclick="fillPhrase('wunde')">Wundbehandlung</button>

      </div>

      <label class="mobile-label" for="selected_text">Dokumentation nach Auswahl</label>
      <textarea
        id="selected_text"
        name="selected_text"
        class="mobile-textarea"
        rows="4"
        placeholder="Tippen Sie or w√§hlen Sie etwas aus: z.B. Lagerung links"
      ></textarea>

        <label class="mobile-label" for="spoken_text">Beobachtung</label>
        <textarea
          id="spoken_text"
          name="spoken_text"
          class="mobile-textarea"
          rows="3"
          placeholder="Sprechen Sie oder tippen Sie: z.B. 'Patient klagt √ºber √úbelkeit, Haut blass', ‚Ä¶"
        ></textarea>

        <div class="mobile-row">
        <button type="button" class="btn-primary btn-full" id="btnStart">üéôÔ∏è Start</button>
        <button type="button" class="btn-secondary btn-full" id="btnStop" disabled>‚èπÔ∏è Stop</button>
      </div>

      <button type="submit" class="btn-primary btn-full">Dokumentieren</button>

      <p class="mobile-hint">
        Hinweis: iPhone Safari ben√∂tigt <strong>HTTPS</strong> und eine Nutzeraktion (Button) f√ºr Mikrofonzugriff.
      </p>
    </form>
  </div>
  </div>


<script>
function fillPhrase(text) {
  const box = document.getElementById("selected_text");
  if (!box.value.trim()) box.value = text;
  else box.value = box.value.trim() + "\n" + text;
  box.focus();
}

/* --- Web Speech API (works on many browsers, iOS Safari support varies) --- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;

const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const spokenBox = document.getElementById("spoken_text");

if (SpeechRecognition) {
  rec = new SpeechRecognition();
  rec.lang = "de-DE";
  rec.interimResults = true;
  rec.continuous = true;

  let finalText = "";

  rec.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const t = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalText += t + "\n";
      else interim += t;
    }
    spokenBox.value = (finalText + interim).trim();
  };

  rec.onend = () => {
    btnStart.disabled = false;
    btnStop.disabled = true;
  };

  btnStart.addEventListener("click", () => {
    try {
      btnStart.disabled = true;
      btnStop.disabled = false;
      rec.start();
    } catch (e) {
      // start can throw if called twice quickly
      btnStart.disabled = false;
      btnStop.disabled = true;
      console.log(e);
    }
  });

  btnStop.addEventListener("click", () => {
    btnStop.disabled = true;
    btnStart.disabled = false;
    rec.stop();
  });
} else {
  // Hide voice buttons if unsupported
  btnStart.style.display = "none";
  btnStop.style.display  = "none";
}
</script>

<script>
function initScanner() {
  let scanControls = null;
  let codeReader = null;

  const startBtn = document.getElementById("startScanBtn");
  const stopBtn  = document.getElementById("stopScanBtn");
  const statusEl = document.getElementById("scanStatus");
  const previewEl = document.getElementById("scanPreview");
  const videoEl  = document.getElementById("scanVideo");
  const patientIdentifierInput = document.getElementById("patientIdentifierInput");

  function setStatus(msg) {
    statusEl.textContent = msg;
  }

  async function stopScan() {
    if (scanControls) {
      scanControls.stop();
      scanControls = null;
    }
    if (codeReader) {
      codeReader.reset();
      codeReader = null;
    }

    videoEl.srcObject = null;
    previewEl.style.display = "none";
    startBtn.style.display = "inline-block";
    stopBtn.style.display = "none";
    setStatus("Scan gestoppt.");
  }

  async function startScan() {
    // SAFETY CHECK ‚Äî this is what was failing before
    if (!window.ZXing) {
      setStatus("Scanner-Library (ZXing) nicht geladen. Seite neu laden.");
      return;
    }

    try {
      codeReader = new ZXing.BrowserMultiFormatReader();

      previewEl.style.display = "block";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      setStatus("Scanne Patienten-Code‚Ä¶");

      scanControls = await codeReader.decodeFromVideoDevice(
        null, // auto-select back camera
        videoEl,
        (result, err) => {
          if (result) {
            const value = result.getText().trim();
            patientIdentifierInput.value = value;
            setStatus("Patient erkannt: " + value);
            stopScan();
          }
        }
      );

    } catch (e) {
      setStatus("Scanner-Fehler: " + e.message);
    }
  }

  startBtn.addEventListener("click", startScan);
  stopBtn.addEventListener("click", stopScan);
}
</script>



</body>
</html>
