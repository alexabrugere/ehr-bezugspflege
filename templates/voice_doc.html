<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sprachdokumentation</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://unpkg.com/@zxing/browser@latest"></script>
</head>
<body>

<div class="header header-mobile">
  <div class="header-title">
    <span class="icon">üéôÔ∏è</span>
    <span>Sprachdokumentation</span>
  </div>
  <div class="nav-links">
      {% if current_nurse %}
            <span class="current-nurse-label">
                üë©‚Äç‚öïÔ∏è Eingeloggt als: {{ current_nurse["name"] }}
            </span>
        {% endif %}
    <a class="nav-pill" href="{{ url_for('home') }}">üè• Home</a>
  </div>
</div>

<div class="container container-mobile">

  <div class="section-card mobile-card">

  <h3>Patient-ID scannen</h3>

  <div class="scan-row">
    <button type="button" class="btn-primary" id="startScanBtn">üì∑ Scan starten</button>
    <button type="button" class="btn-secondary" id="stopScanBtn" style="display:none;">‚èπ Stop</button>
  </div>

    <br>

  <div id="scanStatus" class="scan-status">Bereit.</div>

  <div class="scan-preview" id="scanPreview" style="display:none;">
    <video id="scanVideo" playsinline></video>
  </div>



   <form method="POST" action="{{ url_for('voice_doc') }}" class="mobile-form">
      <label class="mobile-label" for="patientIdentifierInput"></label>
      <input
        type="text"
        id="patientIdentifierInput"
        name="patient_identifier"
        class="mobile-input"
        inputmode="text"
        placeholder="Oder Patient-ID hier eingeben: z.B. P-100001"
        autocomplete="off">


      <div class="mobile-row">
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient teilgewaschen')">Teilw√§sche</button>
        <button type="button" class="btn-secondary btn-full" onclick="fillPhrase('Patient ganzgewaschen')">Ganzw√§sche</button>
      </div>

      <div class="chip-grid">
        <button type="button" class="chip" onclick="fillPhrase('Inhalation durchgef√ºhrt')">Inhalation</button>
        <button type="button" class="chip" onclick="fillPhrase('Urinflasche geleert')">Urinflasche</button>
        <button type="button" class="chip" onclick="fillPhrase('patient links gelagert')">Lagerung links</button>
        <button type="button" class="chip" onclick="fillPhrase('patient rechts gelagert')">Lagerung rechts</button>
        <button type="button" class="chip" onclick="fillPhrase('patient z√§hne geputzt')">Z√§hne geputzt</button>
        <button type="button" class="chip" onclick="fillPhrase('patient geholfen beim Essen')">Essen geholfen</button>
        <button type="button" class="chip" onclick="fillPhrase('Patient aufgekl√§rt')">Info erkl√§rt</button>
        <button type="button" class="chip" onclick="fillPhrase('Postop Kontrolle')">Post-OP Check</button>
        <button type="button" class="chip" onclick="fillPhrase('Mobilisation')">Mobilisation</button>
        <button type="button" class="chip" onclick="fillPhrase('Oberk√∂rperhochlagerung')">Oberk√∂rperhochlagerung</button>
        <button type="button" class="chip" onclick="fillPhrase('Orientierungshilfen')">Orientierungshilfe</button>
        <button type="button" class="chip" onclick="fillPhrase('Wundbehandlung')">Wundbehandlung</button>

      </div>

      <label class="mobile-label" for="selected_text">Dokumentation nach Auswahl</label>
      <textarea
        id="selected_text"
        name="selected_text"
        class="mobile-textarea"
        rows="4"
        placeholder="W√§hlen Sie was aus: z.B. Lagerung links"
      ></textarea>

        <label class="mobile-label" for="spoken_text">Beobachtung</label>
        <textarea
          id="spoken_text"
          name="spoken_text"
          class="mobile-textarea"
          rows="3"
          placeholder="Sprich oder tippe: z.B. 'Patient klagt √ºber √úbelkeit, Haut blass', ‚Ä¶"
        ></textarea>

        <div class="mobile-row">
        <button type="button" class="btn-primary btn-full" id="btnStart">üéôÔ∏è Start</button>
        <button type="button" class="btn-secondary btn-full" id="btnStop" disabled>‚èπÔ∏è Stop</button>
      </div>

      <button type="submit" class="btn-primary btn-full">Dokumentieren</button>

      <p class="mobile-hint">
        Hinweis: iPhone Safari ben√∂tigt <strong>HTTPS</strong> und eine Nutzeraktion (Button) f√ºr Mikrofonzugriff.
      </p>
    </form>
  </div>
  </div>


<script>
function fillPhrase(text) {
  const box = document.getElementById("selected_text");
  if (!box.value.trim()) box.value = text;
  else box.value = box.value.trim() + "\n" + text;
  box.focus();
}

/* --- Web Speech API (works on many browsers, iOS Safari support varies) --- */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let rec = null;

const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const spokenBox = document.getElementById("spoken_text");

if (SpeechRecognition) {
  rec = new SpeechRecognition();
  rec.lang = "de-DE";
  rec.interimResults = true;
  rec.continuous = true;

  let finalText = "";

  rec.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const t = event.results[i][0].transcript;
      if (event.results[i].isFinal) finalText += t + "\n";
      else interim += t;
    }
    spokenBox.value = (finalText + interim).trim();
  };

  rec.onend = () => {
    btnStart.disabled = false;
    btnStop.disabled = true;
  };

  btnStart.addEventListener("click", () => {
    try {
      btnStart.disabled = true;
      btnStop.disabled = false;
      rec.start();
    } catch (e) {
      // start can throw if called twice quickly
      btnStart.disabled = false;
      btnStop.disabled = true;
      console.log(e);
    }
  });

  btnStop.addEventListener("click", () => {
    btnStop.disabled = true;
    btnStart.disabled = false;
    rec.stop();
  });
} else {
  // Hide voice buttons if unsupported
  btnStart.style.display = "none";
  btnStop.style.display  = "none";
}
</script>

<script>

let scanStream = null;
let scanning = false;

const startBtn = document.getElementById("startScanBtn");
const stopBtn  = document.getElementById("stopScanBtn");
const statusEl = document.getElementById("scanStatus");
const previewEl = document.getElementById("scanPreview");
const videoEl  = document.getElementById("scanVideo");

const patientIdentifierInput = document.getElementById("patientIdentifierInput");

function setStatus(msg) {
  statusEl.textContent = msg;
}

async function stopScan() {
  scanning = false;

  if (scanStream) {
    scanStream.getTracks().forEach(t => t.stop());
    scanStream = null;
  }

  videoEl.pause();
  videoEl.srcObject = null;

  previewEl.style.display = "none";
  startBtn.style.display = "inline-block";
  stopBtn.style.display = "none";
  setStatus("Scan gestoppt.");
}

async function startScan() {
  // Camera requires HTTPS (Render is fine)
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    setStatus("Kamera nicht verf√ºgbar. Bitte Patient-ID manuell eingeben.");
    return;
  }

  if ("BarcodeDetector" in window) {
  // use native BarcodeDetector (fast)
    } else {
  // fallback to ZXing (iOS-safe)
  }

  const detector = new BarcodeDetector({
    formats: ["qr_code", "code_128", "code_39", "ean_13", "ean_8", "upc_a", "upc_e"]
  });

  try {
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    videoEl.srcObject = scanStream;
    await videoEl.play();

    scanning = true;
    previewEl.style.display = "block";
    startBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
    setStatus("Bitt scannen Sie und halten Sie den Code ruhig in die Kamera.");

    const tick = async () => {
      if (!scanning) return;

      try {
        const codes = await detector.detect(videoEl);
        if (codes && codes.length > 0) {
          const raw = (codes[0].rawValue || "").trim();
          if (!raw) return requestAnimationFrame(tick);

          // If the QR already contains the patient identifier:
          // e.g. "P-100001" or even just "100001"
          patientIdentifierInput.value = raw;
          setStatus("Patient-ID erkannt: " + raw);
          await stopScan();
          return;
        }
      } catch (e) {
        // ignore transient errors
      }

      requestAnimationFrame(tick);
    };

    requestAnimationFrame(tick);
  } catch (err) {
    setStatus("Kamera-Zugriff abgelehnt oder Fehler: " + err);
    await stopScan();
  }
}

startBtn.addEventListener("click", startScan);
stopBtn.addEventListener("click", stopScan);
</script>

<script>
let codeReader = null;
let scanControls = null;

const startBtn = document.getElementById("startScanBtn");
const stopBtn  = document.getElementById("stopScanBtn");
const statusEl = document.getElementById("scanStatus");
const previewEl = document.getElementById("scanPreview");
const videoEl  = document.getElementById("scanVideo");
const patientIdentifierInput = document.getElementById("patientIdentifierInput");

function setStatus(msg) {
  statusEl.textContent = msg;
}

async function startScan() {
  try {
    codeReader = new ZXing.BrowserMultiFormatReader();

    previewEl.style.display = "block";
    startBtn.style.display = "none";
    stopBtn.style.display = "inline-block";
    setStatus("Scanne Patienten-Code‚Ä¶");

    scanControls = await codeReader.decodeFromVideoDevice(
      null, // auto-select back camera
      videoEl,
      async (result, err) => {
        if (result) {
          const value = result.getText().trim();

          patientIdentifierInput.value = value;
          setStatus("Patient erkannt: " + value);

          await stopScan();
        }
      }
    );

  } catch (e) {
    setStatus("Scanner-Fehler: " + e.message);
  }
}

async function stopScan() {
  if (scanControls) {
    scanControls.stop();
    scanControls = null;
  }
  if (codeReader) {
    codeReader.reset();
    codeReader = null;
  }

  previewEl.style.display = "none";
  startBtn.style.display = "inline-block";
  stopBtn.style.display = "none";
  setStatus("Scan gestoppt.");
}

startBtn.addEventListener("click", startScan);
stopBtn.addEventListener("click", stopScan);
</script>



</body>
</html>
