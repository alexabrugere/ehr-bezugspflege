<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Labore – {{ patient.name if patient else "Alle Patienten" }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

{% extends "base.html" %}
{% block title %}Flowsheet{% endblock %}
{% block content %}


{% include "_patient_tabs.html" %}


    {% if alerts %}
<div class="alert-section">
    <h3>Klinische Warnungen</h3>

    {% for a in alerts %}
        <div class="alert-box {{ a.severity }}">
            <strong>{{ a.severity | upper }}</strong>: {{ a.alert }}
            <div class="alert-time">{{ a["created_at"] | format_dt }}</div>
        </div>
    {% endfor %}
</div>
{% endif %}

    <!-- ========== PENDING LABS ========== -->
    <h3>{{ patient.name }} Laboranforderungen</h3>
    {% if pending_labs %}
        <table class="simple-table">
            <thead>
                <tr>
                    <th>Typ</th>
                    <th>Priorität</th>
                    <th>Angefordert am</th>
                </tr>
            </thead>
            <tbody>
                {% for o in pending_labs %}
                    <tr>
                        <td>{{ o["name"] }}</td>
                        <td>{{ o["priority"] }}</td>
                        <td>{{ o["ordered_at"]| format_dt }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p><em>Keine ausstehenden Laboranforderungen.</em></p>
    {% endif %}

    <!-- ========== RECENT LAB RESULTS (LAST 5 DAYS) ========== -->
    <h3>Letzte Laborwerte (5 Tage)</h3>
    {% if recent_labs %}
        <table class="simple-table">
            <thead>
                <tr>
                    <th>Patient</th>
                    <th>Typ</th>
                    <th>Ergebnis</th>
                    <th>Flag</th>
                    <th>Datum/Zeit</th>
                </tr>
            </thead>
            <tbody>
                {% for r in recent_labs %}
                    <tr>
                        <td>{{ r["patient_name"] }} ({{ r["patient_identifier"] }})</td>
                        <td>{{ r["name"] }}</td>
                        <td>{{ r["result_value"] }}</td>
                        <td>{{ r["result_flag"] or "–" }}</td>
                        <td>{{ r["result_datetime"] }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p><em>Keine Laborwerte in den letzten 5 Tagen.</em></p>
    {% endif %}

    <!-- ========== ORDER NEW LAB ========== -->
    <h3>Neue Laboranforderung</h3>

    <form method="POST" action="{{ url_for('labs_view', patient_id=patient_id) }}">
        <!-- Make sure the server knows the patient -->
        {% if patient_id %}
            <input type="hidden" name="patient_id" value="{{ patient_id }}">
        {% else %}
            <label>Patient auswählen:
                <select name="patient_id" required>
                    <option value="">– bitte wählen –</option>
                    {% for p in patients %}
                        <option value="{{ p['id'] }}">
                            {{ p['name'] }} ({{ p['patient_identifier'] }})
                        </option>
                    {% endfor %}
                </select>
            </label>
            <br>
        {% endif %}

        <label>Typ:
    <select name="lab_name" required>
        <option value="">– Bitte wählen –</option>
        <option value="Blutbild (BB)">Blutbild (BB)</option>
        <option value="CRP">CRP</option>
        <option value="Kreatinin">Kreatinin</option>
        <option value="Natrium">Natrium</option>
        <option value="Kalium">Kalium</option>
    </select>
</label>


        <label>Priorität:
            <select name="priority">
                <option value="">– Bitte wählen –</option>
                <option value="Routine">Routine</option>
                <option value="Dringend">Dringend</option>
                <option value="Stat">Stat</option>
            </select>
        </label>

        <button type="submit" class="btn-primary">Labor anfordern</button>
    </form>

{% endblock %}

</body>
</html>
