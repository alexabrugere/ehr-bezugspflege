<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>EHR Mock â€“ PatientenÃ¼bersicht</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

{% extends "base.html" %}
{% block title %}Flowsheet{% endblock %}
{% block content %}


{% include "_patient_tabs.html" %}


    <h2>PatientenÃ¼bersicht</h2>

 {% for p in patients %}
    <div class="patient-card-horizontal">

        <!-- LEFT: Patient identity -->
        <div class="patient-left">
            <!-- Avatar wrapper (photo OR emoji) -->
            <div class="patient-avatar-wrapper">
                {% if p.photo_filename %}
                    <img src="{{ url_for('static', filename='uploads/' ~ p.photo_filename) }}"
                         alt="Patientenfoto"
                         class="patient-avatar-img">
                {% else %}
                    <div class="patient-avatar-large">
                        {% if p.gender == 'F' %}
                            ðŸ‘©
                        {% elif p.gender == 'M' %}
                            ðŸ‘¨
                        {% else %}
                            ðŸ™‚
                        {% endif %}
                        <span class="badge-room">Zi.{{ p.room }}</span>
                    </div>
                {% endif %}
            </div>

            <div class="patient-name-block">
                <a href="{{ url_for('patient_detail', patient_id=p.id) }}" class="patient-name">
                    {{ p.name }}
                </a>

                <div class="patient-room">
                    ID: {{ p.patient_identifier }}
                </div>

                <div class="badge-allergy">
                    Allergien: {{ p.allergies or "keine" }}
                </div>

                <div class="badge-code">
                    VAW: {{ p.code_status or "nicht festgelegt" }}
                </div>
            </div>
        </div>

        <!-- RIGHT: Clinical info + buttons + AI priorities -->
        <div class="patient-right">
            <!-- Row 1: Diagnose | DOB -->
            <div class="field-row">
              <span class="field-label">Diagnose</span>
              <span class="field-value">{{ p.diagnosis or "â€”" }}</span>
            </div>

            <div class="field-row">
              <span class="field-label">Geburtsdatum</span>
              <span class="field-value">{{ p.dob or "â€”" }}</span>
            </div>

            <div class="field-row">
              <span class="field-label">PrimÃ¤rarzt</span>
              <span class="field-value">{{ p.primary_doctor or "â€”" }}</span>
            </div>

            <div class="field-row">
              <span class="field-label">Bezugspflegeperson</span>
              <span class="field-value">{{ p.bezugspflege_name or "â€”" }}</span>
            </div>

            <div class="field-row">
              <span class="field-label">Aufnahme</span>
              <span class="field-value">{{ p.admission_date or "â€”" }}</span>
            </div>

            <div class="field-row">
              <span class="field-label">Entlassung</span>
              <span class="field-value">{{ p.expected_discharge or "â€”" }}</span>
            </div>


            <!-- Row 4: Flowsheet / Aufgaben / Labs / PrioritÃ¤ten -->
            <div class="patient-actions-row" style="grid-column: 1 / span 2;">
                <a class="btn-primary"
                   href="{{ url_for('flowsheet', patient_id=p.id) }}">
                    Kurve
                </a>
                <a class="btn-secondary"
                   href="{{ url_for('labs_view', patient_id=p.id) }}">
                    Labor
                </a>
                <a class="btn-secondary"
                   href="{{ url_for('tasks_view', patient_id=p.id) }}">
                    Aufgaben
                </a>

                <div class="priority-box table-wrapper">
                    <strong>PrioritÃ¤ten</strong>
                    {% set prios = priorities.get(p.id) %}
                    {% if prios %}
                        <ul>
                            {% for pr in prios %}
                                <li>{{ pr }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <span class="priority-empty">Noch keine Bewertung</span>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
{% endfor %}



<script>
async function fetchAlerts() {
    try {
        const response = await fetch("{{ url_for('api_alerts') }}");
        if (!response.ok) {
            console.error("Alert API error", response.status);
            return;
        }
        const alerts = await response.json();
        renderAlerts(alerts);
    } catch (err) {
        console.error("Alert fetch failed", err);
    }
}

function renderAlerts(alerts) {
    let box = document.getElementById("global-alert-box");

    // Create alert box only once
    if (!box) {
        box = document.createElement("div");
        box.id = "global-alert-box";
        box.className = "alert-container";
        document.body.appendChild(box);
    }

    // No alerts â†’ hide box
    if (!alerts || alerts.length === 0) {
        box.innerHTML = "";
        box.style.display = "none";
        return;
    }

    box.style.display = "block";

    // Build alerts list with close button
    box.innerHTML = `
        ${alerts.map(a => {
            const sevClass =
                a.severity === "high" ? "alert-high" :
                a.severity === "medium" ? "alert-medium" :
                "alert-low";

            return `
                <div class="alert ${sevClass}">
                <button class="alert-close" onclick="closeGlobalAlert()">âœ–</button>
                    <strong>${a.type}</strong>
                    <div>${a.patient_name} (${a.patient_identifier})</div>
                    <div>${a.message}</div>
                </div>
            `;
        }).join("")}
    `;
}

// Close function with fade-out animation
function closeGlobalAlert() {
    const box = document.getElementById("global-alert-box");
    box.classList.add("fade-out");

    setTimeout(() => {
        box.style.display = "none";
        box.classList.remove("fade-out");
    }, 400); // matches animation duration
}

// Initial load + refresh
fetchAlerts();
setInterval(fetchAlerts, 60000);
</script>

{% endblock %}

</body>
</html>


