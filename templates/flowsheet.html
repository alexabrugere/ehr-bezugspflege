<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Flowsheet – {{ patient.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

{% extends "base.html" %}
{% block title %}Flowsheet{% endblock %}
{% block content %}

<body>


{% include "_patient_tabs.html" %}


    {% if alerts %}
<div class="alert-section">
    <h3>Klinische Warnungen</h3>

    {% for a in alerts %}
        <div class="alert-box {{ a.severity }}">
            <strong>{{ a.severity | upper }}</strong>: {{ a.alert }}
            <div class="alert-time">{{ a["created_at"].replace("T", " ") }}</div>
        </div>
    {% endfor %}
</div>
{% endif %}


    <h2>Flowsheet für {{ patient.name }}</h2>

    <hr><br>

    <!-- ================= LAST 5 ASSESSMENTS (VITALS – HORIZONTAL TABLE) ================= -->
   <h2>Letzte 5 Einschätzungen</h2>

{% if recent_assessments %}
<div class="vitals-history-card">
    <table class="vitals-history-table">
        <thead>
            <tr>
                <th>Parameter</th>
                {% for a in recent_assessments %}
                    <th>{{ a["created_at"].replace("T", " ") }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Temp (°C)</td>
                {% for a in recent_assessments %}
                    <td>
                        {% if a.temperature is not none %}
                            <span class="vital-chip and {% if a.temperature < 36 or a.temperature > 38 %}vital-high{% endif %}">
                                {{ a.temperature }}</span>
                        {% else %}–{% endif %}
                    </td>
                {% endfor %}
            </tr>
            <tr>
                <td>Puls</td>
                {% for a in recent_assessments %}
                    <td>
                        {% if a.heart_rate is not none %}
                            <span class="vital-chip and {% if a.heart_rate < 60 or a.heart_rate > 110 %}vital-high{% endif %}">
                                {{ a.heart_rate }}</span>
                        {% else %}–{% endif %}
                    </td>
                {% endfor %}
            </tr>
            <tr>
                <td>AF</td>
                {% for a in recent_assessments %}
                    <td>
                        {% if a.respiration_rate is not none %}
                            <span class="vital-chip {% if a.respiration_rate < 12 or a.respiration_rate > 20 %}vital-high{% endif %}">
                                {{ a.respiration_rate }}
                            </span>
                        {% else %}–{% endif %}
                    </td>
                {% endfor %}
            </tr>
            <tr>
                <td>RR syst</td>
                {% for a in recent_assessments %}
                    <td>
                        {% if a.systolic_bp is not none %}
                            <span class="vital-chip {% if a.systolic_bp < 90 or a.systolic_bp > 140 %}vital-high{% endif %}">
                                {{ a.systolic_bp }}
                            </span>
                        {% else %}–{% endif %}
                    </td>
                {% endfor %}
            </tr>
                <tr>
                    <td>RR diast</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.diastolic_bp is not none %}
                                <span class="vital-chip {% if a.diastolic_bp < 60 or a.diastolic_bp > 90 %}vital-high{% endif %}">
                                    {{ a.diastolic_bp }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>SpO₂ (%)</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.oxygen_sat is not none %}
                                <span class="vital-chip {% if a.oxygen_sat < 90 %}vital-high{% endif %}">
                                    {{ a.oxygen_sat }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>

            </tbody>
    </table>
</div>
{% else %}
    <p>Noch keine Einschätzungen vorhanden.</p>
{% endif %}


            {% if recent_assessments %}
<div class="vitals-history-card">
    <table class="vitals-history-table">
        <thead>
            <tr>
                <th>Parameter</th>
                {% for a in recent_assessments %}
                    <th>{{ a["created_at"].replace("T", " ") }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>

                <tr>
                    <td>Schmerzen</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.pain is not none %}
                                <span class="vital-chip {% if a.pain > 6 %}vital-high{% endif %}">
                                    {{ a.pain }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                <tr>
                    <td>Gewicht</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.weight is not none %}
                                <span class="vital-chip {% if a.weight > 90 %}vital-high{% endif %}">
                                    {{ a.weight }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                 <tr>
                    <td>Mobilität</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.mobility is not none %}
                                <span class="vital-chip {% if a.mobility < 3 %}vital-high{% endif %}">
                                    {{ a.mobility }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                 <tr>
                    <td>Ödem</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.edema is not none %}
                                <span class="vital-chip {% if a.edema > 8 %}vital-high{% endif %}">
                                    {{ a.edema }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                 <tr>
                    <td>Verwirrtheit</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.confusion is not none %}
                                <span class="vital-chip {% if a.confusion > 8 %}vital-high{% endif %}">
                                    {{ a.confusion }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                 <tr>
                    <td>Ernährung</td>
                    {% for a in recent_assessments %}
                        <td>
                            {% if a.nutrition is not none %}
                                <span class="vital-chip {% if a.nutrition < 4 %}vital-high{% endif %}">
                                    {{ a.nutrition }}
                                </span>
                            {% else %}–{% endif %}
                        </td>
                    {% endfor %}
                </tr>

        </tbody>
    </table>
</div>
{% else %}
    <p>Noch keine Einschätzungen vorhanden.</p>
{% endif %}


    <br><hr><br>

    <!-- ================= FLOWSHEET ENTRY FORM ================= -->
    <h2>Neue Einschätzung hier oder mit dem Messungsgerät dokumentieren </h2>

    <form action="{{ url_for('flowsheet', patient_id=patient.id) }}" method="POST">

        <!-- -------- VITALS: HORIZONTAL GRID -------- -->
        <div class="table-wrapper vitals-card">
        <div class="table-wrapper vitals-grid">
             <label><span class="vital-label">Atemfrequenz</span>
                <input type="number" name="respiration_rate" min="0" max="80">
            </label>
            <label><span class="vital-label">Puls (bpm)</span>
                <input type="number" name="heart_rate" min="0" max="250">
            </label>
            <label><span class="vital-label">Temperatur (°C)</span>
                <input type="number" step="0.1" name="temperature" min="25" max="45">
            </label>
            <label><span class="vital-label">SpO₂ (%)</span>
                <input type="number" name="oxygen_sat" min="50" max="100">
            </label>
            <label><span class="vital-label">RR systolisch</span>
                <input type="number" name="systolic_bp" min="40" max="250">
            </label>
            <label><span class="vital-label">RR diastolisch</span>
                <input type="number" name="diastolic_bp" min="20" max="150">
            </label>


             <label><span class="vital-label">Schmerzen</span>
                <input type="number" name="pain" min=0 max="10">
            </label>
            <label><span class="vital-label">Gewicht</span>
                <input type="number" name="weight" min=0 max="300">
            </label>
             <label><span class="vital-label">Mobilität</span>
                <input type="number" name="mobility" min=0 max="10">
            </label>
            <label><span class="vital-label">Ödem</span>
                <input type="number" name="edema" min=0 max="10">
            </label>
            <label><span class="vital-label">Verwirrtheit</span>
                <input type="number" name="confusion" min=0 max=10>
            </label>
            <label><span class="vital-label">Ernährung</span>
                <input type="number" name="nutrition" min=0 max="10">
            </label>
        </div>
            </div>



    <br><hr><br>


<button type="submit" class="btn-primary">Einschätzung speichern</button>


   </form>


<!-- ============ ALERT JAVASCRIPT (unchanged) ============ -->
<script>
async function fetchAlerts() {
    try {
        const response = await fetch("{{ url_for('api_alerts') }}");
        if (!response.ok) {
            console.error("Alert API error", response.status);
            return;
        }
        const alerts = await response.json();
        renderAlerts(alerts);
    } catch (err) {
        console.error("Alert fetch failed", err);
    }
}

function renderAlerts(alerts) {
    let box = document.getElementById("global-alert-box");

    if (!box) {
        box = document.createElement("div");
        box.id = "global-alert-box";
        box.className = "alert-container";
        document.body.appendChild(box);
    }

    if (!alerts || alerts.length === 0) {
        box.innerHTML = "";
        box.style.display = "none";
        return;
    }

    box.style.display = "block";

    box.innerHTML = `
        ${alerts.map(a => {
            const sevClass =
                a.severity === "high" ? "alert-high" :
                a.severity === "medium" ? "alert-medium" :
                "alert-low";

            return `
                <div class="alert ${sevClass}">
                    <button class="alert-close" onclick="closeGlobalAlert()">✖</button>
                    <strong>${a.type}</strong>
                    <div>${a.patient_name} (${a.patient_identifier})</div>
                    <div>${a.message}</div>
                </div>
            `;
        }).join("")}
    `;
}

function closeGlobalAlert() {
    const box = document.getElementById("global-alert-box");
    box.classList.add("fade-out");

    setTimeout(() => {
        box.style.display = "none";
        box.classList.remove("fade-out");
    }, 400);
}

fetchAlerts();
setInterval(fetchAlerts, 60000);
</script>

<!-- ============ ALERT JAVASCRIPT (unchanged) ============ -->
<script>
async function fetchAlerts() {
    try {
        const response = await fetch("{{ url_for('api_alerts') }}");
        if (!response.ok) {
            console.error("Alert API error", response.status);
            return;
        }
        const alerts = await response.json();
        renderAlerts(alerts);
    } catch (err) {
        console.error("Alert fetch failed", err);
    }
}

function renderAlerts(alerts) {
    let box = document.getElementById("global-alert-box");

    if (!box) {
        box = document.createElement("div");
        box.id = "global-alert-box";
        box.className = "alert-container";
        document.body.appendChild(box);
    }

    if (!alerts || alerts.length === 0) {
        box.innerHTML = "";
        box.style.display = "none";
        return;
    }

    box.style.display = "block";

    box.innerHTML = `
        ${alerts.map(a => {
            const sevClass =
                a.severity === "high" ? "alert-high" :
                a.severity === "medium" ? "alert-medium" :
                "alert-low";

            return `
                <div class="alert ${sevClass}">
                    <button class="alert-close" onclick="closeGlobalAlert()">✖</button>
                    <strong>${a.type}</strong>
                    <div>${a.patient_name} (${a.patient_identifier})</div>
                    <div>${a.message}</div>
                </div>
            `;
        }).join("")}
    `;
}

function closeGlobalAlert() {
    const box = document.getElementById("global-alert-box");
    box.classList.add("fade-out");

    setTimeout(() => {
        box.style.display = "none";
        box.classList.remove("fade-out");
    }, 400);
}

fetchAlerts();
setInterval(fetchAlerts, 60000);
</script>

{% endblock %}

</body>

</html>


